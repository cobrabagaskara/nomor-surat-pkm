<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Nomor Surat Pasien V1.5</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #f3f4f6;
      margin: 0;
      padding: 16px;
    }

    h1 {
      text-align: center;
      margin-bottom: 4px;
    }

    .subtitle {
      text-align: center;
      font-size: 14px;
      color: #6b7280;
      margin-bottom: 16px;
    }

    .card {
      background: white;
      border-radius: 14px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 8px 20px rgba(0,0,0,.06);
    }

    select, input {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      margin-bottom: 10px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      box-sizing: border-box;
    }

    button {
      width: 100%;
      padding: 18px;
      font-size: 26px;
      border: none;
      border-radius: 12px;
      background: #2563eb;
      color: white;
      cursor: pointer;
      margin-bottom: 8px;
    }

    button.small {
      font-size: 16px;
      padding: 12px;
      background: #4b5563;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }

    th, td {
      padding: 8px;
      border-bottom: 1px solid #e5e7eb;
      font-size: 14px;
      text-align: left;
    }

    td.copy {
      cursor: pointer;
      color: #2563eb;
      transition: background 0.2s;
    }

    td.copy:hover {
      background: #f0f9ff;
    }

    .tabs {
      display: flex;
      background: #e5e7eb;
      border-radius: 999px;
      padding: 4px;
      margin-bottom: 16px;
    }

    .tab {
      flex: 1;
      border: none;
      background: transparent;
      padding: 12px;
      font-size: 15px;
      cursor: pointer;
      border-radius: 999px;
      color: #374151;
    }

    .tab.active {
      background: white;
      font-weight: 600;
      box-shadow: 0 6px 14px rgba(0,0,0,.08);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    #toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: #111827;
      color: white;
      padding: 12px 20px;
      border-radius: 999px;
      font-size: 14px;
      opacity: 0;
      pointer-events: none;
      transition: opacity .3s ease, transform .3s ease;
      z-index: 1000;
    }

    #toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(-6px);
    }

    .empty-state {
      text-align: center;
      color: #9ca3af;
      padding: 20px;
      font-style: italic;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #6b7280;
    }

    .refresh-btn {
      position: absolute;
      right: 16px;
      top: 16px;
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      color: #6b7280;
    }

    .refresh-btn:hover {
      background: #f3f4f6;
      color: #374151;
    }
  </style>
</head>

<body>

<div style="display:flex;align-items:center;justify-content:center;gap:8px;position:relative;">
  <h1 style="margin:0;">Nomor Surat Pasien</h1>
  <span onclick="toggleSettings()" style="cursor:pointer;font-size:20px;">‚öôÔ∏è</span>
  <button class="refresh-btn" onclick="loadData()" title="Refresh data">üîÑ</button>
</div>
<p class="subtitle">Sistem penomoran surat bersama lintas ruang</p>


<div class="card">
  <select id="ruang">
    <option value="">Pilih Ruang</option>
    <option>R1</option>
    <option>R2</option>
    <option>R3</option>
  </select>
</div>

<div id="settingsPanel" class="card" style="display:none;">
  <h3>Pengaturan</h3>

  <h4>Nomor Awal</h4>
  <input id="initSKB" placeholder="Nomor terakhir SKB (misal 24)" type="number">
  <button class="small" onclick="setInitial('SKB')">Simpan SKB</button>
  <br><br>
  <input id="initKEUR" placeholder="Nomor terakhir KEUR (misal 18)" type="number">
  <button class="small" onclick="setInitial('KEUR')">Simpan KEUR</button>

  <hr style="margin:16px 0;">

  <h4>Bulan & Tahun</h4>
  <input id="bulan">
  <input id="tahun" type="number">
  
  <div style="margin-top: 16px; text-align: center;">
    <button class="small" onclick="resetLocalData()">Reset Cache Lokal</button>
  </div>
</div>


<div class="tabs">
  <button class="tab active" onclick="switchTab('SKB')">SKB</button>
  <button class="tab" onclick="switchTab('KEUR')">KEUR</button>
</div>

<div id="SKB" class="tab-content active card">
  <button onclick="generateNumber('SKB')">Buat Nomor SKB +</button>
  <table id="tableSKB">
    <thead>
      <tr><th>Nomor Surat</th><th>Ruang</th><th>Waktu</th></tr>
    </thead>
    <tbody>
      <tr><td colspan="3" class="loading">Memuat data...</td></tr>
    </tbody>
  </table>
</div>

<div id="KEUR" class="tab-content card">
  <button onclick="generateNumber('KEUR')">Buat Nomor KEUR +</button>
  <table id="tableKEUR">
    <thead>
      <tr><th>Nomor Surat</th><th>Ruang</th><th>Waktu</th></tr>
    </thead>
    <tbody>
      <tr><td colspan="3" class="loading">Memuat data...</td></tr>
    </tbody>
  </table>
</div>

<div id="toast"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import {
    getFirestore, collection, query, orderBy, limit, onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBd54K4gt0NaEfcf_E43wZVqnjM7Mi6GAA",
    authDomain: "nomor-surat-pkm.firebaseapp.com",
    projectId: "nomor-surat-pkm",
    storageBucket: "nomor-surat-pkm.firebasestorage.app",
    messagingSenderId: "825283193186",
    appId: "1:825283193186:web:683e6df9631fca4590a43b"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Fungsi untuk inspect data structure
  window.inspectData = () => {
    console.log("=== INSPECTING FIREBASE DATA STRUCTURE ===");
    
    const q = query(collection(db, "history"), limit(5));
    
    const unsubscribe = onSnapshot(q, 
      (snapshot) => {
        console.log("üìä Data Structure Analysis:");
        
        snapshot.docs.forEach((doc, index) => {
          const data = doc.data();
          console.log(`\nüìÑ Document ${index + 1}:`);
          console.log("  ID:", doc.id);
          
          // Log semua field
          Object.keys(data).forEach(key => {
            const value = data[key];
            console.log(`  ${key}:`, value, `(type: ${typeof value})`);
            
            // Cek khusus untuk time field
            if (key === 'time') {
              console.log(`    ‚è∞ Time details:`, 
                value?.constructor?.name,
                value?.toDate ? "Has toDate() method" : "No toDate() method"
              );
            }
          });
          
          // Cek field type
          if (!data.type) {
            console.log("  ‚ö†Ô∏è  MISSING 'type' FIELD!");
          }
        });
        
        unsubscribe();
        
        // Analisis
        console.log("\nüîç ANALYSIS:");
        const firstDoc = snapshot.docs[0]?.data();
        if (firstDoc) {
          console.log("1. Field yang ada:", Object.keys(firstDoc));
          console.log("2. Contoh nomor surat:", firstDoc.nomor);
          console.log("3. Type field:", firstDoc.type || "NOT FOUND");
          console.log("4. Time field type:", 
            firstDoc.time?.constructor?.name || "NOT FOUND");
        }
      },
      (error) => {
        console.error("‚ùå Inspection error:", error);
      }
    );
  };

  // Load data dengan error handling yang lebih baik
  window.loadTableData = (type) => {
    const tbody = document.querySelector(`#table${type} tbody`);
    
    // Query SEMUA data dulu (tanpa filter type di query)
    const q = query(
      collection(db, "history"), 
      orderBy("time", "desc"), 
      limit(20)
    );
    
    const unsubscribe = onSnapshot(q, 
      (snapshot) => {
        console.log(`üì• ${type}: Received ${snapshot.docs.length} total documents`);
        
        // Filter di client side
        const filteredDocs = [];
        
        snapshot.docs.forEach(doc => {
          const data = doc.data();
          console.log(`  Checking doc: type="${data.type}", nomor="${data.nomor}"`);
          
          if (data.type === type) {
            filteredDocs.push(doc);
          }
        });
        
        console.log(`  ‚Ü≥ Found ${filteredDocs.length} ${type} documents`);
        
        if (filteredDocs.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="3" class="empty-state">
                Belum ada data ${type}.<br>
                <small>Tip: Buat nomor ${type} pertama dengan tombol "+"</small>
              </td>
            </tr>
          `;
        } else {
          renderTable(type, filteredDocs);
        }
      },
      (error) => {
        console.error(`‚ùå ${type} listener error:`, error);
        
        // Fallback: coba tanpa orderBy jika error
        if (error.code === 'failed-precondition') {
          console.log(`‚ö†Ô∏è  ${type}: Trying without orderBy...`);
          loadWithoutOrderBy(type);
        } else {
          tbody.innerHTML = `
            <tr>
              <td colspan="3" style="color:#dc2626;text-align:center;padding:20px;">
                Error loading ${type}: ${error.code}<br>
                <button onclick="loadTableData('${type}')" 
                        style="margin-top:10px;padding:5px 10px;background:#dc2626;color:white;border:none;border-radius:4px;">
                  Coba Lagi
                </button>
              </td>
            </tr>
          `;
        }
      }
    );
    
    // Simpan unsubscribe untuk cleanup nanti
    window[`unsubscribe${type}`] = unsubscribe;
  };

  window.loadWithoutOrderBy = (type) => {
    const tbody = document.querySelector(`#table${type} tbody`);
    
    const q = query(collection(db, "history"), limit(20));
    
    onSnapshot(q, 
      (snapshot) => {
        const filteredDocs = snapshot.docs.filter(doc => doc.data().type === type);
        
        // Sort manual di client side
        filteredDocs.sort((a, b) => {
          const timeA = a.data().time;
          const timeB = b.data().time;
          
          // Handle jika time adalah timestamp
          if (timeA && timeA.toDate && timeB && timeB.toDate) {
            return timeB.toDate() - timeA.toDate();
          }
          
          // Handle jika time adalah string atau number
          if (timeA && timeB) {
            return new Date(timeB) - new Date(timeA);
          }
          
          return 0;
        });
        
        renderTable(type, filteredDocs.slice(0, 10)); // Ambil 10 terbaru
      },
      (error) => {
        console.error(`Even without orderBy error:`, error);
        tbody.innerHTML = '<tr><td colspan="3" class="empty-state">Error loading data</td></tr>';
      }
    );
  };

  window.renderTable = (type, docs) => {
    const tbody = document.querySelector(`#table${type} tbody`);
    
    let html = '';
    docs.forEach(doc => {
      const data = doc.data();
      
      // Format waktu
      let timeDisplay = "Waktu tidak tersedia";
      try {
        if (data.time) {
          if (data.time.toDate) {
            // Firestore timestamp
            const date = data.time.toDate();
            timeDisplay = date.toLocaleTimeString('id-ID', {
              hour: '2-digit',
              minute: '2-digit'
            });
          } else if (typeof data.time === 'string' || typeof data.time === 'number') {
            // String atau timestamp number
            const date = new Date(data.time);
            timeDisplay = date.toLocaleTimeString('id-ID', {
              hour: '2-digit',
              minute: '2-digit'
            });
          }
        }
      } catch (e) {
        console.warn("Time formatting error:", e);
      }
      
      html += `
        <tr>
          <td class="copy" onclick="copyText('${data.nomor || ''}')" 
              style="cursor:pointer;color:#2563eb;padding:12px 8px;">
            <strong>${data.nomor || 'No number'}</strong>
            <div style="font-size:12px;color:#6b7280;margin-top:2px;">
              üìã Klik untuk menyalin
            </div>
          </td>
          <td style="padding:12px 8px;">
            <span style="background:#f3f4f6;padding:4px 8px;border-radius:4px;">
              ${data.ruang || '-'}
            </span>
          </td>
          <td style="padding:12px 8px;">${timeDisplay}</td>
        </tr>
      `;
    });
    
    tbody.innerHTML = html;
  };

  // Initialize
  document.addEventListener('DOMContentLoaded', () => {
    console.log("üöÄ Initializing application...");
    
    // Jalankan inspect untuk debugging
    window.inspectData();
    
    // Tunggu 1 detik, lalu load data
    setTimeout(() => {
      console.log("Loading table data...");
      window.loadTableData('SKB');
      window.loadTableData('KEUR');
    }, 1000);
    
    // Auto bulan & tahun
    const bulanRomawi = ["I","II","III","IV","V","VI","VII","VIII","IX","X","XI","XII"];
    const now = new Date();
    document.getElementById("bulan").value = bulanRomawi[now.getMonth()];
    document.getElementById("tahun").value = now.getFullYear();
  });

  // Toast function
  window.showToast = (text, type = 'info') => {
    const toast = document.getElementById("toast");
    toast.textContent = text;
    toast.style.background = type === 'error' ? '#dc2626' : 
                            type === 'success' ? '#059669' : '#111827';
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 3000);
  };

  window.copyText = (text) => {
    if (!text) {
      showToast("Tidak ada teks untuk disalin", 'error');
      return;
    }
    navigator.clipboard.writeText(text)
      .then(() => showToast("Nomor surat disalin", 'success'))
      .catch(() => showToast("Gagal menyalin", 'error'));
  };
</script>

</body>
</html>
