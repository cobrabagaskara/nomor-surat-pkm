<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Nomor Surat Pasien V1.4</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #f3f4f6;
      margin: 0;
      padding: 16px;
    }

    h1 {
      text-align: center;
      margin-bottom: 4px;
    }

    .subtitle {
      text-align: center;
      font-size: 14px;
      color: #6b7280;
      margin-bottom: 16px;
    }

    .card {
      background: white;
      border-radius: 14px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 8px 20px rgba(0,0,0,.06);
    }

    select, input {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      margin-bottom: 10px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      box-sizing: border-box;
    }

    button {
      width: 100%;
      padding: 18px;
      font-size: 26px;
      border: none;
      border-radius: 12px;
      background: #2563eb;
      color: white;
      cursor: pointer;
      margin-bottom: 8px;
    }

    button.small {
      font-size: 16px;
      padding: 12px;
      background: #4b5563;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }

    th, td {
      padding: 8px;
      border-bottom: 1px solid #e5e7eb;
      font-size: 14px;
      text-align: left;
    }

    td.copy {
      cursor: pointer;
      color: #2563eb;
      transition: background 0.2s;
    }

    td.copy:hover {
      background: #f0f9ff;
    }

    .tabs {
      display: flex;
      background: #e5e7eb;
      border-radius: 999px;
      padding: 4px;
      margin-bottom: 16px;
    }

    .tab {
      flex: 1;
      border: none;
      background: transparent;
      padding: 12px;
      font-size: 15px;
      cursor: pointer;
      border-radius: 999px;
      color: #374151;
    }

    .tab.active {
      background: white;
      font-weight: 600;
      box-shadow: 0 6px 14px rgba(0,0,0,.08);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    #toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: #111827;
      color: white;
      padding: 12px 20px;
      border-radius: 999px;
      font-size: 14px;
      opacity: 0;
      pointer-events: none;
      transition: opacity .3s ease, transform .3s ease;
      z-index: 1000;
    }

    #toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(-6px);
    }

    .empty-state {
      text-align: center;
      color: #9ca3af;
      padding: 20px;
      font-style: italic;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #6b7280;
    }

    .refresh-btn {
      position: absolute;
      right: 16px;
      top: 16px;
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      color: #6b7280;
    }

    .refresh-btn:hover {
      background: #f3f4f6;
      color: #374151;
    }
  </style>
</head>

<body>

<div style="display:flex;align-items:center;justify-content:center;gap:8px;position:relative;">
  <h1 style="margin:0;">Nomor Surat Pasien</h1>
  <span onclick="toggleSettings()" style="cursor:pointer;font-size:20px;">‚öôÔ∏è</span>
  <button class="refresh-btn" onclick="loadData()" title="Refresh data">üîÑ</button>
</div>
<p class="subtitle">Sistem penomoran surat bersama lintas ruang</p>


<div class="card">
  <select id="ruang">
    <option value="">Pilih Ruang</option>
    <option>R1</option>
    <option>R2</option>
    <option>R3</option>
  </select>
</div>

<div id="settingsPanel" class="card" style="display:none;">
  <h3>Pengaturan</h3>

  <h4>Nomor Awal</h4>
  <input id="initSKB" placeholder="Nomor terakhir SKB (misal 24)" type="number">
  <button class="small" onclick="setInitial('SKB')">Simpan SKB</button>
  <br><br>
  <input id="initKEUR" placeholder="Nomor terakhir KEUR (misal 18)" type="number">
  <button class="small" onclick="setInitial('KEUR')">Simpan KEUR</button>

  <hr style="margin:16px 0;">

  <h4>Bulan & Tahun</h4>
  <input id="bulan">
  <input id="tahun" type="number">
  
  <div style="margin-top: 16px; text-align: center;">
    <button class="small" onclick="resetLocalData()">Reset Cache Lokal</button>
  </div>
</div>


<div class="tabs">
  <button class="tab active" onclick="switchTab('SKB')">SKB</button>
  <button class="tab" onclick="switchTab('KEUR')">KEUR</button>
</div>

<div id="SKB" class="tab-content active card">
  <button onclick="generateNumber('SKB')">Buat Nomor SKB +</button>
  <table id="tableSKB">
    <thead>
      <tr><th>Nomor Surat</th><th>Ruang</th><th>Waktu</th></tr>
    </thead>
    <tbody>
      <tr><td colspan="3" class="loading">Memuat data...</td></tr>
    </tbody>
  </table>
</div>

<div id="KEUR" class="tab-content card">
  <button onclick="generateNumber('KEUR')">Buat Nomor KEUR +</button>
  <table id="tableKEUR">
    <thead>
      <tr><th>Nomor Surat</th><th>Ruang</th><th>Waktu</th></tr>
    </thead>
    <tbody>
      <tr><td colspan="3" class="loading">Memuat data...</td></tr>
    </tbody>
  </table>
</div>

<div id="toast"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import {
    getFirestore, collection, query, orderBy, limit, onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBd54K4gt0NaEfcf_E43wZVqnjM7Mi6GAA",
    authDomain: "nomor-surat-pkm.firebaseapp.com",
    projectId: "nomor-surat-pkm",
    storageBucket: "nomor-surat-pkm.firebasestorage.app",
    messagingSenderId: "825283193186",
    appId: "1:825283193186:web:683e6df9631fca4590a43b"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Debug function
  window.debugFirestore = async () => {
    try {
      console.log("=== DEBUG FIREBASE CONNECTION ===");
      
      // Test 1: Coba akses collection tanpa filter
      const testQuery = query(collection(db, "history"), limit(1));
      const unsubscribe = onSnapshot(testQuery, 
        (snapshot) => {
          console.log("‚úÖ Connection successful");
          console.log("Sample data:", snapshot.docs.map(d => d.data()));
          unsubscribe();
        },
        (error) => {
          console.error("‚ùå Firestore error:", error);
          console.error("Error code:", error.code);
          console.error("Error message:", error.message);
          
          if (error.code === 'failed-precondition') {
            console.log("‚ö†Ô∏è  You need to create an index in Firebase Console");
            console.log("Go to: Firebase Console > Firestore > Indexes");
          }
        }
      );
      
    } catch (error) {
      console.error("‚ùå Setup error:", error);
    }
  };

  // Load saat halaman dibuka
  document.addEventListener('DOMContentLoaded', () => {
    console.log("Running debug...");
    window.debugFirestore();
    
    // Coba load data dengan cara sederhana
    loadDataSimple('SKB');
    loadDataSimple('KEUR');
  });

  // Fungsi sederhana tanpa filter where
  window.loadDataSimple = async (type) => {
    const tbody = document.querySelector(`#table${type} tbody`);
    
    try {
      console.log(`Loading ${type} data...`);
      
      // Query sederhana tanpa where()
      const q = query(
        collection(db, "history"), 
        orderBy("time", "desc"), 
        limit(15)
      );
      
      const unsubscribe = onSnapshot(q, 
        (snapshot) => {
          console.log(`${type} snapshot received:`, snapshot.docs.length, "docs");
          
          if (snapshot.empty) {
            tbody.innerHTML = '<tr><td colspan="3" class="empty-state">Belum ada data</td></tr>';
            return;
          }
          
          // Filter di client side
          const filteredDocs = snapshot.docs.filter(doc => {
            const data = doc.data();
            return data.type === type;
          });
          
          updateTableSimple(type, filteredDocs);
        },
        (error) => {
          console.error(`Error loading ${type}:`, error);
          tbody.innerHTML = `<tr><td colspan="3" style="color:#dc2626;text-align:center;">
            Error: ${error.code}<br>
            ${error.message}
          </td></tr>`;
        }
      );
      
    } catch (error) {
      console.error(`Setup error for ${type}:`, error);
      tbody.innerHTML = '<tr><td colspan="3" class="empty-state">Error setup</td></tr>';
    }
  };

  window.updateTableSimple = (type, docs) => {
    const tbody = document.querySelector(`#table${type} tbody`);
    
    if (!docs || docs.length === 0) {
      tbody.innerHTML = '<tr><td colspan="3" class="empty-state">Belum ada data ' + type + '</td></tr>';
      return;
    }
    
    let html = '';
    docs.forEach(doc => {
      const x = doc.data();
      let timeStr = 'Waktu tidak tersedia';
      
      try {
        if (x.time && x.time.toDate) {
          const time = x.time.toDate();
          timeStr = time.toLocaleTimeString('id-ID', {
            hour: '2-digit',
            minute: '2-digit'
          });
        }
      } catch (e) {
        console.warn("Time parsing error:", e);
      }
      
      html += `
        <tr>
          <td class="copy" onclick="copyText('${x.nomor || ''}')">
            ${x.nomor || 'No number'} üìã
          </td>
          <td>${x.ruang || '-'}</td>
          <td>${timeStr}</td>
        </tr>
      `;
    });
    
    tbody.innerHTML = html;
  };

  // Toast function
  window.showToast = (text) => {
    const toast = document.getElementById("toast");
    toast.textContent = text;
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 3000);
  };

  window.copyText = (text) => {
    navigator.clipboard.writeText(text);
    showToast("Nomor disalin");
  };
</script>

</body>
</html>
