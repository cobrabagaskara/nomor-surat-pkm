<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Nomor Surat Bersama</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #f3f4f6;
      margin: 0;
      padding: 16px;
    }
    h1 {
      text-align: center;
      margin-bottom: 12px;
    }
    .card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
      box-shadow: 0 8px 20px rgba(0,0,0,.06);
    }
    select, input {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      margin-bottom: 10px;
    }
    button {
      width: 100%;
      padding: 16px;
      font-size: 22px;
      border: none;
      border-radius: 10px;
      background: #2563eb;
      color: white;
      cursor: pointer;
    }
    button:disabled {
      background: #9ca3af;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 8px;
      border-bottom: 1px solid #e5e7eb;
      font-size: 14px;
    }
    .small {
      font-size: 12px;
      color: #6b7280;
      text-align: center;
    }
  </style>
</head>

<body>

<h1>NOMOR SURAT BERSAMA</h1>

<div class="card">
  <select id="ruang">
    <option value="">Pilih Ruang</option>
    <option>R1</option>
    <option>R2</option>
    <option>R3</option>
  </select>

  <input id="bulan" value="II">
  <input id="tahun" value="2026">
</div>

<div class="card">
  <h3>SKB</h3>
  <button onclick="generateNumber('SKB')">+</button>
  <table id="tableSKB">
    <thead><tr><th>Nomor</th><th>Ruang</th><th>Jam</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<div class="card">
  <h3>KEUR</h3>
  <button onclick="generateNumber('KEUR')">+</button>
  <table id="tableKEUR">
    <thead><tr><th>Nomor</th><th>Ruang</th><th>Jam</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<div class="card">
  <h3>Set Nomor Awal</h3>
  <input id="initSKB" placeholder="Nomor terakhir SKB (misal 24)">
  <button onclick="setInitial('SKB')">Simpan SKB</button>
  <input id="initKEUR" placeholder="Nomor terakhir KEUR (misal 18)">
  <button onclick="setInitial('KEUR')">Simpan KEUR</button>
</div>

<p class="small">Nomor diberikan oleh sistem Â· jangan refresh saat klik</p>

<!-- FIREBASE -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import {
    getFirestore, doc, getDoc, setDoc,
    updateDoc, increment, collection,
    addDoc, query, orderBy, limit, onSnapshot, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBd54K4gt0NaEfcf_E43wZVqnjM7Mi6GAA",
    authDomain: "nomor-surat-pkm.firebaseapp.com",
    projectId: "nomor-surat-pkm",
    storageBucket: "nomor-surat-pkm.firebasestorage.app",
    messagingSenderId: "825283193186",
    appId: "1:825283193186:web:683e6df9631fca4590a43b"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  window.generateNumber = async (type) => {
    const ruang = document.getElementById('ruang').value;
    if (!ruang) {
      alert('Pilih ruang terlebih dahulu');
      return;
    }

    const bulan = document.getElementById('bulan').value;
    const tahun = document.getElementById('tahun').value;

    const counterRef = doc(db, 'counters', type);
    const snap = await getDoc(counterRef);

    if (!snap.exists()) {
      alert('Nomor awal belum di-set');
      return;
    }

    await updateDoc(counterRef, { value: increment(1) });

    const newSnap = await getDoc(counterRef);
    const no = String(newSnap.data().value).padStart(5, '0');

    const full = `400.7/${no}/${type}/PKM.KDG/${bulan}/${tahun}`;

    await addDoc(collection(db, 'history'), {
      type, ruang, nomor: full, time: serverTimestamp()
    });
  };

  window.setInitial = async (type) => {
    const val = document.getElementById(type === 'SKB' ? 'initSKB' : 'initKEUR').value;
    if (!val) return;
    await setDoc(doc(db, 'counters', type), { value: Number(val) });
    alert('Nomor awal disimpan');
  };

  ['SKB','KEUR'].forEach(type => {
    const q = query(
      collection(db, 'history'),
      orderBy('time','desc'),
      limit(5)
    );
    onSnapshot(q, snap => {
      const tbody = document.querySelector(`#table${type} tbody`);
      tbody.innerHTML = '';
      snap.docs
        .filter(d => d.data().type === type)
        .forEach(d => {
          const x = d.data();
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${x.nomor}</td><td>${x.ruang}</td><td>${x.time?.toDate().toLocaleTimeString()}</td>`;
          tbody.appendChild(tr);
        });
    });
  });
</script>

</body>
</html>
